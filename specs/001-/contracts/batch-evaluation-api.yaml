openapi: 3.0.3
info:
  title: Batch Document Evaluation API
  description: API for batch processing of documents for disclosure compliance evaluation
  version: 1.0.0
  contact:
    name: Disclosure Evaluator Team
    email: support@disclosure-evaluator.org

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server
  - url: https://api.disclosure-evaluator.org/v1
    description: Production server

paths:
  /batches:
    post:
      summary: Create a new batch evaluation
      description: Start a new batch evaluation with the provided documents
      operationId: createBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateBatchRequest"
      responses:
        "201":
          description: Batch created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchEvaluation"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationError"

    get:
      summary: List all batches
      description: Retrieve a list of all batch evaluations
      operationId: listBatches
      parameters:
        - name: status
          in: query
          description: Filter by batch status
          schema:
            $ref: "#/components/schemas/BatchStatus"
        - name: limit
          in: query
          description: Maximum number of batches to return
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
        - name: offset
          in: query
          description: Number of batches to skip
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: List of batches
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchListResponse"

  /batches/{batch_id}:
    get:
      summary: Get batch details
      description: Retrieve details of a specific batch evaluation
      operationId: getBatch
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
      responses:
        "200":
          description: Batch details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchEvaluation"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      summary: Delete batch
      description: Delete a batch and all its associated data
      operationId: deleteBatch
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
      responses:
        "204":
          description: Batch deleted successfully
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/start:
    post:
      summary: Start batch processing
      description: Begin processing the documents in a batch
      operationId: startBatch
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
      responses:
        "200":
          description: Batch processing started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchEvaluation"
        "400":
          description: Batch cannot be started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/status:
    get:
      summary: Get batch status
      description: Retrieve the current status and progress of a batch
      operationId: getBatchStatus
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
      responses:
        "200":
          description: Batch status and progress
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchProgress"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/results:
    get:
      summary: Get batch results
      description: Retrieve the evaluation results for a completed batch
      operationId: getBatchResults
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
        - name: format
          in: query
          description: Output format for results
          schema:
            type: string
            enum: [json, summary, csv]
            default: json
      responses:
        "200":
          description: Batch results
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchResult"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Batch not completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/resume:
    post:
      summary: Resume batch processing
      description: Resume processing of a failed or interrupted batch
      operationId: resumeBatch
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
      responses:
        "200":
          description: Batch processing resumed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchEvaluation"
        "400":
          description: Batch cannot be resumed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/documents:
    get:
      summary: List batch documents
      description: Retrieve all documents in a batch
      operationId: listBatchDocuments
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
        - name: status
          in: query
          description: Filter by document status
          schema:
            $ref: "#/components/schemas/DocumentStatus"
      responses:
        "200":
          description: List of documents in the batch
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DocumentListResponse"
        "404":
          description: Batch not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /batches/{batch_id}/documents/{document_id}:
    get:
      summary: Get document details
      description: Retrieve details of a specific document in a batch
      operationId: getBatchDocument
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
        - name: document_id
          in: path
          required: true
          description: Unique document identifier
          schema:
            type: string
      responses:
        "200":
          description: Document details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchDocument"
        "404":
          description: Document not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    post:
      summary: Retry document processing
      description: Retry processing of a failed document
      operationId: retryDocument
      parameters:
        - name: batch_id
          in: path
          required: true
          description: Unique batch identifier
          schema:
            type: string
        - name: document_id
          in: path
          required: true
          description: Unique document identifier
          schema:
            type: string
      responses:
        "200":
          description: Document retry initiated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BatchDocument"
        "400":
          description: Document cannot be retried
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Document not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    CreateBatchRequest:
      type: object
      required:
        - documents
        - configuration
      properties:
        documents:
          type: array
          items:
            $ref: "#/components/schemas/DocumentInput"
          minItems: 1
          maxItems: 100
        configuration:
          $ref: "#/components/schemas/BatchConfiguration"
        folder_path:
          type: string
          description: Path to folder containing documents (alternative to documents array)

    DocumentInput:
      type: object
      required:
        - file_path
      properties:
        file_path:
          type: string
          description: Path to the document file
        file_name:
          type: string
          description: Original filename
        context:
          type: string
          description: Additional context for evaluation
        output_text:
          type: string
          description: Output text for evaluation

    BatchConfiguration:
      type: object
      properties:
        max_concurrent_workers:
          type: integer
          minimum: 1
          maximum: 20
          default: 5
        max_retry_attempts:
          type: integer
          minimum: 0
          maximum: 10
          default: 3
        timeout_seconds:
          type: integer
          minimum: 30
          maximum: 3600
          default: 300
        progress_update_interval:
          type: integer
          minimum: 1
          maximum: 100
          default: 10
        enable_resumption:
          type: boolean
          default: true
        output_formats:
          type: array
          items:
            type: string
            enum: [json, summary, csv]
          default: [json, summary]

    BatchEvaluation:
      type: object
      required:
        - batch_id
        - created_at
        - status
        - total_documents
        - processed_documents
        - successful_documents
        - failed_documents
        - correlation_id
      properties:
        batch_id:
          type: string
          description: Unique batch identifier
        created_at:
          type: string
          format: date-time
        status:
          $ref: "#/components/schemas/BatchStatus"
        total_documents:
          type: integer
          minimum: 0
        processed_documents:
          type: integer
          minimum: 0
        successful_documents:
          type: integer
          minimum: 0
        failed_documents:
          type: integer
          minimum: 0
        processing_started_at:
          type: string
          format: date-time
        processing_completed_at:
          type: string
          format: date-time
        error_summary:
          type: string
        correlation_id:
          type: string
        configuration:
          $ref: "#/components/schemas/BatchConfiguration"

    BatchStatus:
      type: string
      enum:
        - pending
        - processing
        - completed
        - failed
        - partially_failed

    BatchProgress:
      type: object
      required:
        - batch_id
        - current_phase
        - total_documents
        - processed_documents
        - progress_percentage
        - last_updated
      properties:
        batch_id:
          type: string
        current_phase:
          $ref: "#/components/schemas/ProcessingPhase"
        total_documents:
          type: integer
          minimum: 0
        processed_documents:
          type: integer
          minimum: 0
        successful_documents:
          type: integer
          minimum: 0
        failed_documents:
          type: integer
          minimum: 0
        progress_percentage:
          type: number
          minimum: 0
          maximum: 100
        estimated_completion:
          type: string
          format: date-time
        current_document:
          type: string
        active_workers:
          type: integer
          minimum: 0
        error_count:
          type: integer
          minimum: 0
        last_updated:
          type: string
          format: date-time

    ProcessingPhase:
      type: string
      enum:
        - initializing
        - discovering
        - processing
        - aggregating
        - completed

    BatchResult:
      type: object
      required:
        - batch_id
        - total_documents
        - successful_evaluations
        - failed_evaluations
        - success_rate
        - processing_duration
        - generated_at
      properties:
        batch_id:
          type: string
        total_documents:
          type: integer
          minimum: 0
        successful_evaluations:
          type: integer
          minimum: 0
        failed_evaluations:
          type: integer
          minimum: 0
        success_rate:
          type: number
          minimum: 0
          maximum: 1
        processing_duration:
          type: string
          format: duration
        average_evaluation_time:
          type: string
          format: duration
        summary_statistics:
          $ref: "#/components/schemas/BatchSummaryStatistics"
        individual_results:
          type: array
          items:
            $ref: "#/components/schemas/DocumentResult"
        error_summary:
          type: array
          items:
            $ref: "#/components/schemas/DocumentError"
        generated_at:
          type: string
          format: date-time

    BatchSummaryStatistics:
      type: object
      properties:
        average_score:
          type: number
          minimum: 1
          maximum: 5
        score_distribution:
          type: object
          additionalProperties:
            type: integer
        most_common_criteria:
          type: array
          items:
            type: string
        processing_efficiency:
          type: number
          minimum: 0
        error_rate:
          type: number
          minimum: 0
          maximum: 1

    DocumentResult:
      type: object
      required:
        - document_id
        - success
      properties:
        document_id:
          type: string
        evaluation_result:
          type: object
          description: Full evaluation result (DisclosureEvaluationResult)
        processing_time:
          type: string
          format: duration
        success:
          type: boolean

    DocumentError:
      type: object
      required:
        - document_id
        - error_type
        - error_message
        - occurred_at
      properties:
        document_id:
          type: string
        error_type:
          type: string
        error_message:
          type: string
        retry_count:
          type: integer
          minimum: 0
        occurred_at:
          type: string
          format: date-time

    BatchDocument:
      type: object
      required:
        - document_id
        - batch_id
        - file_path
        - file_name
        - file_size
        - mime_type
        - status
        - correlation_id
      properties:
        document_id:
          type: string
        batch_id:
          type: string
        file_path:
          type: string
        file_name:
          type: string
        file_size:
          type: integer
          minimum: 0
        mime_type:
          type: string
        status:
          $ref: "#/components/schemas/DocumentStatus"
        processing_started_at:
          type: string
          format: date-time
        processing_completed_at:
          type: string
          format: date-time
        evaluation_result:
          type: object
          description: Evaluation result if successful
        error_message:
          type: string
        retry_count:
          type: integer
          minimum: 0
        correlation_id:
          type: string

    DocumentStatus:
      type: string
      enum:
        - pending
        - processing
        - completed
        - failed

    BatchListResponse:
      type: object
      required:
        - batches
        - total_count
        - limit
        - offset
      properties:
        batches:
          type: array
          items:
            $ref: "#/components/schemas/BatchEvaluation"
        total_count:
          type: integer
          minimum: 0
        limit:
          type: integer
          minimum: 1
        offset:
          type: integer
          minimum: 0

    DocumentListResponse:
      type: object
      required:
        - documents
        - total_count
      properties:
        documents:
          type: array
          items:
            $ref: "#/components/schemas/BatchDocument"
        total_count:
          type: integer
          minimum: 0

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
        correlation_id:
          type: string

    ValidationError:
      type: object
      required:
        - error
        - message
        - validation_errors
      properties:
        error:
          type: string
          enum: [validation_error]
        message:
          type: string
        validation_errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
              value:
                type: string

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

security:
  - ApiKeyAuth: []

tags:
  - name: batches
    description: Batch evaluation operations
  - name: documents
    description: Document processing operations
  - name: results
    description: Result retrieval operations
